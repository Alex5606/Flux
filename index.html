<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flux - New Year Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========== RESET & BASE ========== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html { height: 100%; height: -webkit-fill-available; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100%;
            min-height: -webkit-fill-available;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        button, input, textarea { font: inherit; border: none; outline: none; background: none; }
        button { cursor: pointer; user-select: none; transition: all 0.2s ease; }
        button:active { transform: scale(0.96); }
        a { text-decoration: none; color: inherit; }
        img { max-width: 100%; display: block; }
        .hidden { display: none !important; }

        /* ========== THEME ========== */
        :root {
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --holiday-red: #ef4444;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #e2e8f0;
            --bg-input: #f8fafc;
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            
            --border: #e2e8f0;
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
            --radius: 12px;
            
            --nav-width: 72px;
            --list-width: 320px;
            --header-height: 64px;
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-input: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        [data-theme="christmas"] {
            --bg-main: #0b1120;
            --bg-card: #151e32;
            --bg-hover: #232d4b;
            --bg-input: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --primary: #ef4444;
            --primary-gradient: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            --border: #334155;
        }

        /* Snowfall */
        .snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
        .snowflake { position: absolute; color: #fff; opacity: 0.8; animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-10vh); opacity: 1; } 100% { transform: translateY(100vh); opacity: 0.3; } }

        /* Layout */
        .app-screen { display: flex; height: 100%; position: relative; z-index: 2; }
        
        /* Sidebar */
        .nav-sidebar {
            width: var(--nav-width); background: var(--bg-card); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 50;
        }
        .nav-logo { width: 40px; height: 40px; background: var(--primary-gradient); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-bottom: 30px; }
        .nav-item { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); margin-bottom: 12px; position: relative; }
        .nav-item.active, .nav-item:hover { background: var(--bg-hover); color: var(--primary); }
        .nav-badge { position: absolute; top: -2px; right: -2px; background: var(--holiday-red); color: white; font-size: 10px; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        /* List Panel */
        .list-panel { width: var(--list-width); background: var(--bg-main); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { font-size: 22px; font-weight: 700; }
        .panel-search { margin: 0 16px 16px; position: relative; }
        .panel-search input { width: 100%; padding: 10px 16px 10px 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); }
        .panel-search svg { position: absolute; left: 12px; top: 12px; width: 18px; height: 18px; color: var(--text-secondary); }
        .list-items { flex: 1; overflow-y: auto; padding: 0 10px 10px; }
        .list-item { display: flex; align-items: center; padding: 12px; border-radius: var(--radius); cursor: pointer; margin-bottom: 4px; transition: background 0.2s; }
        .list-item:hover { background: var(--bg-hover); }
        .list-item.active { background: rgba(99, 102, 241, 0.15); }
        [data-theme="christmas"] .list-item.active { background: rgba(239, 68, 68, 0.2); }

        .item-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 12px; position: relative; flex-shrink: 0; }
        .item-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .online-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--success); border: 2px solid var(--bg-card); border-radius: 50%; }
        .santa-hat { position: absolute; top: -15px; left: -10px; width: 30px; height: 30px; z-index: 5; pointer-events: none; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3)); }
        
        .item-content { flex: 1; min-width: 0; }
        .item-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .item-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-time { font-size: 12px; color: var(--text-secondary); }
        .item-preview { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px; }
        
        /* Main Area */
        .main-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-card); position: relative; }
        .chat-header { height: var(--header-height); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: var(--bg-card); z-index: 10; }
        .chat-user { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .chat-status { font-size: 13px; color: var(--text-secondary); }
        .chat-status.online { color: var(--success); }
        .chat-status.typing { color: var(--primary); font-weight: 500; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px; }
        .message-group { display: flex; flex-direction: column; gap: 2px; max-width: 70%; position: relative; }
        .message-group.own { align-self: flex-end; align-items: flex-end; }
        .message-bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-group:not(.own) .message-bubble { background: var(--bg-hover); border-bottom-left-radius: 4px; }
        .message-group.own .message-bubble { background: var(--primary-gradient); color: white; border-bottom-right-radius: 4px; }
        .message-meta { display: flex; align-items: center; gap: 4px; font-size: 11px; margin-top: 2px; opacity: 0.7; justify-content: flex-end; min-width: 50px; }
        .own .message-meta { color: rgba(255,255,255,0.9); }
        .message-image { border-radius: 12px; max-width: 280px; cursor: pointer; border: 1px solid var(--border); }
        .tick { width: 14px; height: 14px; }
        .tick.read { color: #6ee7b7; }

        /* Input */
        .input-area { padding: 16px 20px; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; align-items: flex-end; gap: 12px; }
        .input-wrapper { flex: 1; background: var(--bg-input); border-radius: 24px; border: 1px solid var(--border); display: flex; align-items: center; padding: 4px 12px; min-height: 48px; }
        .message-input { flex: 1; padding: 10px 0; max-height: 100px; overflow-y: auto; resize: none; }
        .voice-btn, .send-btn, .action-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .voice-btn:hover, .action-btn:hover { background: var(--bg-hover); }
        .send-btn { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .voice-btn.recording { background: var(--danger); color: white; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-card { background: var(--bg-card); border-radius: 24px; padding: 30px; width: 90%; max-width: 400px; box-shadow: var(--shadow-xl); transform: scale(0.9); transition: transform 0.2s; border: 1px solid var(--border); }
        .modal-overlay.open .modal-card { transform: scale(1); }

        /* Loading */
        .loading-screen { position: fixed; inset: 0; background: var(--primary-gradient); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loading-screen.fade-out { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 768px) {
            :root { --nav-width: 0px; --list-width: 100%; }
            .nav-sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; padding: 0 20px; justify-content: space-around; border-top: 1px solid var(--border); border-right: none; }
            .nav-logo, .nav-item:last-child { display: none; }
            .nav-item { margin: 0; }
            .list-panel { width: 100%; height: calc(100% - 60px); }
            .main-area { position: fixed; inset: 0; z-index: 60; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .main-area.open { transform: translateX(0); }
            .back-btn { display: flex !important; }
        }

        /* Utils */
        .avatar-1 { background: linear-gradient(135deg, #f472b6, #ec4899); }
        .avatar-2 { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }
        .avatar-3 { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .avatar-4 { background: linear-gradient(135deg, #34d399, #10b981); }
        .avatar-5 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000; }
        .toast.show { opacity: 1; }
        
        /* Auth */
        .auth-screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: url('https://images.unsplash.com/photo-1544084944-152696a63f72?auto=format&fit=crop&w=1950&q=80') center/cover; z-index: 999; }
        .auth-screen::before { content: ''; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); }
        .auth-container { width: 100%; max-width: 400px; background: var(--bg-card); border-radius: 24px; padding: 40px; position: relative; z-index: 10; border: 1px solid var(--border); }
        .auth-input { width: 100%; padding: 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; color: var(--text-primary); }
    </style>
</head>
<body data-theme="christmas">

    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ Flux...</p>
    </div>

    <div class="snow-container" id="snowContainer"></div>
    <div class="toast" id="toast"></div>

    <!-- Auth -->
    <div class="auth-screen hidden" id="authScreen">
        <div class="auth-container">
            <div style="font-size: 40px; text-align: center; margin-bottom: 10px;">üéÖ</div>
            <h1 style="text-align: center; margin-bottom: 30px; font-weight: 800; font-size: 28px; color: var(--text-primary);">Flux</h1>
            
            <form id="loginForm">
                <input type="email" class="auth-input" id="email" placeholder="Email" required>
                <input type="password" class="auth-input" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <button type="submit" class="auth-input" style="background: var(--primary-gradient); color: white; font-weight: 600;">–í–æ–π—Ç–∏</button>
                <button type="button" class="auth-input" style="background: transparent; border: none; color: var(--text-secondary);" id="toggleAuth">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div class="app-screen hidden" id="appScreen">
        <!-- Sidebar -->
        <nav class="nav-sidebar">
            <div class="nav-logo">F</div>
            <button class="nav-item active" onclick="switchTab('chats')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                <span class="nav-badge hidden" id="globalUnread">0</span>
            </button>
            <button class="nav-item" onclick="switchTab('users')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
            </button>
            <button class="nav-item" onclick="switchTab('settings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            <div style="margin-top: auto; padding-bottom: 20px;">
                <div class="item-avatar" id="myAvatar">?</div>
            </div>
        </nav>

        <!-- Panels -->
        <aside class="list-panel" id="panel-chats">
            <div class="panel-header">
                <h2>–ß–∞—Ç—ã</h2>
                <button class="action-btn" onclick="openCreateGroupModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"></path></svg>
                </button>
            </div>
            <div class="panel-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                <input type="text" placeholder="–ü–æ–∏—Å–∫..." oninput="filterList('chatsList', this.value)">
            </div>
            <div class="list-items" id="chatsList"></div>
        </aside>

        <aside class="list-panel hidden" id="panel-users">
            <div class="panel-header"><h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2></div>
            <div class="panel-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                <input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="filterList('usersList', this.value)">
            </div>
            <div class="list-items" id="usersList"></div>
        </aside>

        <aside class="list-panel hidden" id="panel-settings">
            <div class="panel-header"><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
            <div style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">–ò–º—è</label>
                    <input type="text" id="settingsName" class="auth-input">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:600;">–°—Ç–∞—Ç—É—Å</label>
                    <input type="text" id="settingsStatus" class="auth-input">
                </div>
                <button class="auth-input" style="background: var(--primary); color:white;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                
                <hr style="border-top:1px solid var(--border); margin: 20px 0;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —Ä–µ–∂–∏–º ‚ùÑÔ∏è</span>
                    <input type="checkbox" checked onchange="toggleSnow(this.checked)">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞ üåô</span>
                    <input type="checkbox" onchange="toggleTheme(this.checked)">
                </div>
                <button class="auth-input" style="background:var(--bg-hover); color:var(--danger);" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </aside>

        <!-- Main Chat -->
        <main class="main-area" id="mainArea">
            <div id="emptyState" style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <div style="font-size:60px; margin-bottom:20px;">üéÑ</div>
                <h2 style="font-size:24px; font-weight:bold; margin-bottom:10px;">Flux Messenger</h2>
                <p style="color:var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>

            <div id="chatView" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                <header class="chat-header">
                    <button class="action-btn back-btn hidden" onclick="closeChat()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg>
                    </button>
                    <div class="chat-user" onclick="viewContactInfo()">
                        <div class="item-avatar" id="chatAvatar">?</div>
                        <div>
                            <h3 id="chatName" style="font-weight:600; font-size:16px;">Name</h3>
                            <div id="chatStatus" class="chat-status">offline</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="action-btn" onclick="toggleSearchInChat()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                        </button>
                        <button class="action-btn" onclick="startCall()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                        </button>
                    </div>
                </header>

                <div class="panel-search hidden" id="inChatSearch" style="padding: 10px; margin: 0; background: var(--bg-card); border-bottom: 1px solid var(--border);">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="top:22px;"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.35-4.35"></path></svg>
                     <input type="text" placeholder="–ü–æ–∏—Å–∫ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ..." oninput="searchMessages(this.value)">
                </div>

                <div class="messages-container" id="messagesList"></div>

                <div class="input-area" style="position:relative;">
                    <div id="recordingUI" class="hidden" style="position:absolute; inset:0; background:var(--bg-card); z-index:5; display:flex; align-items:center; justify-content:space-between; padding:0 20px;">
                        <button class="action-btn" style="color:var(--danger);" onclick="cancelRecording()">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <span id="recordingTime" style="font-family:monospace; color:var(--danger); font-weight:600; font-size:18px;">00:00</span>
                        <button class="action-btn" style="color:var(--success); background:var(--success-bg);" onclick="stopRecording()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>

                    <button class="action-btn" onclick="document.getElementById('fileInput').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    <input type="file" id="fileInput" hidden accept="image/*">
                    
                    <div class="input-wrapper">
                        <textarea id="msgInput" class="message-input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleInput(this)"></textarea>
                    </div>
                    
                    <button class="voice-btn" id="voiceBtn" onclick="startRecording()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button class="send-btn hidden" id="sendBtn" onclick="sendMessage('text')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="groupModal">
        <div class="modal-card">
            <h2 style="font-size:20px; font-weight:700; margin-bottom:20px;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <input type="text" id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" class="auth-input">
            <div style="margin-bottom:10px; font-weight:600;">–£—á–∞—Å—Ç–Ω–∏–∫–∏:</div>
            <div id="groupUserList" style="max-height:200px; overflow-y:auto; margin-bottom:20px; border:1px solid var(--border); border-radius:12px;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="auth-input" style="width:auto; background:transparent; color:var(--text-primary);" onclick="$('groupModal').classList.remove('open')">–û—Ç–º–µ–Ω–∞</button>
                <button class="auth-input" style="width:auto; background:var(--primary); color:white;" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile as updateAuthProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, set, get, update, remove, onValue, off, onDisconnect, serverTimestamp, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const config = {
            apiKey: "AIzaSyCr9Dejkc-LsxGPxZaY7UBiJ1LdZHlhaos",
            authDomain: "flux-messenger-9afab.firebaseapp.com",
            databaseURL: "https://flux-messenger-9afab-default-rtdb.firebaseio.com",
            projectId: "flux-messenger-9afab",
            storageBucket: "flux-messenger-9afab.firebasestorage.app",
            messagingSenderId: "268837058726",
            appId: "1:268837058726:web:ce018384e9b34a2a4edc67"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const $ = id => document.getElementById(id);

        let currentUser = null;
        let users = {};
        let chats = {};
        let activeChatId = null;
        let activeChat = null;
        let typingTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let timerInt = null;

        // Init & Loading Fix
        createSnow();
        
        // Safety timeout to hide loading screen
        setTimeout(() => {
            const ls = $('loadingScreen');
            if(ls) ls.classList.add('fade-out');
        }, 3000);

        onAuthStateChanged(auth, user => {
            $('loadingScreen').classList.add('fade-out');
            
            if (user) {
                currentUser = user;
                $('authScreen').classList.add('hidden');
                $('appScreen').classList.remove('hidden');
                setupPresence();
                loadData();
            } else {
                currentUser = null;
                $('authScreen').classList.remove('hidden');
                $('appScreen').classList.add('hidden');
            }
        });

        // UI Logic
        window.switchTab = (tab) => {
            document.querySelectorAll('.list-panel').forEach(p => p.classList.add('hidden'));
            $(`panel-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(tab === 'chats') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(tab === 'users') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(tab === 'settings') document.querySelectorAll('.nav-item')[2].classList.add('active');
        };

        window.toggleSnow = (v) => $('snowContainer').style.display = v ? 'block' : 'none';
        window.toggleTheme = (v) => document.body.setAttribute('data-theme', v ? 'dark' : 'christmas');
        function createSnow() {
            const c = $('snowContainer');
            for(let i=0; i<30; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake';
                s.innerHTML = '‚ùÑ';
                s.style.left = Math.random()*100+'vw';
                s.style.animationDuration = (Math.random()*3+2)+'s';
                s.style.fontSize = (Math.random()*10+10)+'px';
                c.appendChild(s);
            }
        }

        // Auth
        $('loginForm').onsubmit = async e => {
            e.preventDefault();
            const email = $('email').value;
            const pw = $('password').value;
            const isRegister = $('toggleAuth').textContent === '–í–æ–π—Ç–∏';
            
            try {
                if (isRegister) {
                    const cred = await createUserWithEmailAndPassword(auth, email, pw);
                    await updateAuthProfile(cred.user, { displayName: email.split('@')[0] });
                    await set(ref(db, `users/${cred.user.uid}`), {
                        name: email.split('@')[0], email,
                        avatarColor: 'avatar-'+(Math.floor(Math.random()*5)+1),
                        online: true
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pw);
                }
            } catch(err) {
                showToast(err.message);
            }
        };
        $('toggleAuth').onclick = function() {
            const isReg = this.textContent === '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
            this.textContent = isReg ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
            $('loginForm').querySelector('button[type="submit"]').textContent = isReg ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
        };
        window.logout = () => signOut(auth);

        // Data
        function setupPresence() {
            const uRef = ref(db, `users/${currentUser.uid}`);
            onValue(ref(db, '.info/connected'), snap => {
                if (snap.val()) {
                    onDisconnect(uRef).update({ online: false, lastSeen: serverTimestamp() });
                    update(uRef, { online: true });
                }
            });
        }
        function loadData() {
            onValue(ref(db, 'users'), s => { users = s.val() || {}; renderUsers(); renderChats(); });
            onValue(ref(db, `user-chats/${currentUser.uid}`), s => { chats = s.val() || {}; renderChats(); });
            
            get(ref(db, `users/${currentUser.uid}`)).then(s => {
                const u = s.val();
                $('myAvatar').textContent = u.name[0];
                $('myAvatar').className = `item-avatar ${u.avatarColor}`;
                $('settingsName').value = u.name;
                $('settingsStatus').value = u.status || '';
            });
        }

        // Rendering
        function renderUsers() {
            const list = $('usersList');
            list.innerHTML = '';
            Object.entries(users).forEach(([uid, u]) => {
                if (uid === currentUser.uid) return;
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerHTML = `
                    <div class="item-avatar ${u.avatarColor || 'avatar-1'}">
                        <img src="https://cdn-icons-png.flaticon.com/512/744/744546.png" class="santa-hat">
                        ${u.name[0]}
                        ${u.online ? '<div class="online-dot"></div>' : ''}
                    </div>
                    <div class="item-content">
                        <div class="item-name">${u.name}</div>
                        <div class="item-preview">${u.status || 'Happy New Year!'}</div>
                    </div>
                `;
                el.onclick = () => openChat(uid);
                list.appendChild(el);
            });
            
            const gList = $('groupUserList');
            gList.innerHTML = '';
            Object.entries(users).forEach(([uid, u]) => {
                if (uid === currentUser.uid) return;
                const d = document.createElement('div');
                d.style.padding = '8px';
                d.style.display = 'flex';
                d.style.alignItems = 'center';
                d.innerHTML = `<input type="checkbox" value="${uid}" style="margin-right:10px;"> ${u.name}`;
                gList.appendChild(d);
            });
        }

        function renderChats() {
            const list = $('chatsList');
            list.innerHTML = '';
            const sorted = Object.entries(chats).sort((a,b) => b[1].timestamp - a[1].timestamp);
            let totalUnread = 0;
            
            sorted.forEach(([id, c]) => {
                const u = users[id] || { name: c.name || 'Group', avatarColor: 'avatar-1' };
                const isGroup = !!c.name;
                
                const el = document.createElement('div');
                el.className = `list-item ${activeChatId === id ? 'active' : ''}`;
                
                const time = c.timestamp ? new Date(c.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                const unread = c.unread ? `<div style="background:var(--primary); color:white; font-size:10px; padding:2px 6px; border-radius:10px;">${c.unread}</div>` : '';
                totalUnread += (c.unread || 0);

                el.innerHTML = `
                    <div class="item-avatar ${u.avatarColor || 'avatar-1'}">
                        ${!isGroup ? '<img src="https://cdn-icons-png.flaticon.com/512/744/744546.png" class="santa-hat">' : ''}
                        ${isGroup ? 'G' : u.name[0]}
                        ${u.online ? '<div class="online-dot"></div>' : ''}
                    </div>
                    <div class="item-content">
                        <div class="item-top"><span class="item-name">${isGroup ? c.name : u.name}</span><span class="item-time">${time}</span></div>
                        <div class="item-top"><span class="item-preview">${c.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</span>${unread}</div>
                    </div>
                `;
                el.onclick = () => openChat(id, isGroup);
                list.appendChild(el);
            });

            const badge = $('globalUnread');
            badge.textContent = totalUnread;
            if(totalUnread > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        }

        // Chat
        window.openChat = async (id, isGroup = false) => {
            activeChatId = id;
            activeChat = isGroup ? { ...chats[id], id } : users[id];
            
            $('emptyState').classList.add('hidden');
            $('chatView').classList.remove('hidden');
            $('mainArea').classList.add('open');
            
            $('chatName').textContent = isGroup ? activeChat.name : activeChat.name;
            $('chatAvatar').textContent = isGroup ? 'G' : activeChat.name[0];
            $('chatAvatar').className = `item-avatar ${activeChat.avatarColor || 'avatar-1'}`;
            
            if(!isGroup) {
                const last = activeChat.online ? 'Online' : 'Offline';
                $('chatStatus').textContent = last;
                $('chatStatus').className = `chat-status ${activeChat.online ? 'online' : ''}`;
                
                const typeRef = ref(db, `typing/${getChatId(id)}/${id}`);
                onValue(typeRef, s => {
                    if(s.val()) {
                        $('chatStatus').textContent = 'Typing...';
                        $('chatStatus').classList.add('typing');
                    } else {
                        $('chatStatus').textContent = activeChat.online ? 'Online' : 'Offline';
                        $('chatStatus').classList.remove('typing');
                    }
                });
            } else {
                $('chatStatus').textContent = 'Group';
            }

            update(ref(db, `user-chats/${currentUser.uid}/${id}`), { unread: 0 });

            const chatId = isGroup ? id : getChatId(id);
            onValue(query(ref(db, `messages/${chatId}`), limitToLast(50)), snap => {
                const msgs = [];
                snap.forEach(c => msgs.push({key:c.key, ...c.val()}));
                renderMessages(msgs);
            });
            
            renderChats();
        };

        function getChatId(uid) { return [currentUser.uid, uid].sort().join('_'); }

        function renderMessages(msgs) {
            const list = $('messagesList');
            list.innerHTML = '';
            msgs.forEach(m => {
                const div = document.createElement('div');
                const own = m.sender === currentUser.uid;
                div.className = `message-group ${own ? 'own' : ''}`;
                div.ondblclick = () => toggleReaction(activeChatId, m.key, own);
                
                let content = '';
                if(m.type === 'text') content = `<div class="message-bubble">${m.text}</div>`;
                if(m.type === 'image') content = `<img src="${m.content}" class="message-image" onclick="window.open(this.src)">`;
                if(m.type === 'audio') content = `<div class="message-bubble" onclick="playAudio('${m.content}')">‚ñ∂ Audio Message</div>`;
                
                const reaction = m.reaction ? `<div style="position:absolute; bottom:-10px; ${own?'left:0':'right:0'}; background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:2px 5px; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">‚ù§Ô∏è</div>` : '';
                const time = new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const tick = own ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="tick ${m.read ? 'read' : ''}"><polyline points="20 6 9 17 4 12"></polyline></svg>` : '';
                
                div.innerHTML = `${content}${reaction}<div class="message-meta">${time}${tick}</div>`;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        }

        window.sendMessage = async (type, content) => {
            const txt = $('msgInput').value.trim();
            if(!txt && !content) return;
            
            const chatId = activeChat.name ? activeChatId : getChatId(activeChatId);
            
            const msg = {
                sender: currentUser.uid,
                text: type === 'text' ? txt : (type === 'audio' ? 'Voice' : 'Image'),
                type,
                content: content || null,
                timestamp: serverTimestamp(),
                read: false
            };
            
            await push(ref(db, `messages/${chatId}`), msg);
            
            const updates = {};
            updates[`user-chats/${currentUser.uid}/${activeChatId}`] = {
                lastMessage: msg.text, timestamp: serverTimestamp(), unread: 0,
                ...(activeChat.name ? { name: activeChat.name } : {})
            };
            
            if (activeChat.name) {
                // Simplified group fanout
            } else {
                const recipientPath = `user-chats/${activeChatId}/${currentUser.uid}`;
                get(ref(db, recipientPath)).then(s => {
                    const u = s.val()?.unread || 0;
                    update(ref(db, recipientPath), {
                        lastMessage: msg.text, timestamp: serverTimestamp(), unread: u + 1
                    });
                });
            }
            
            update(ref(db), updates);
            
            if(type === 'text') {
                $('msgInput').value = '';
                handleInput($('msgInput'));
            }
        };

        window.handleInput = (el) => {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            const hasText = el.value.trim().length > 0;
            $('sendBtn').classList.toggle('hidden', !hasText);
            $('voiceBtn').classList.toggle('hidden', hasText);
            
            if(!activeChat.name) {
                const chatId = getChatId(activeChatId);
                set(ref(db, `typing/${chatId}/${currentUser.uid}`), true);
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => remove(ref(db, `typing/${chatId}/${currentUser.uid}`)), 2000);
            }
        };

        window.toggleSearchInChat = () => $('inChatSearch').classList.toggle('hidden');
        window.searchMessages = (term) => {
            const els = $('messagesList').querySelectorAll('.message-group');
            els.forEach(el => {
                const txt = el.innerText.toLowerCase();
                el.style.display = txt.includes(term.toLowerCase()) ? 'flex' : 'none';
            });
        };

        window.startRecording = () => {
            navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                mediaRecorder = new MediaRecorder(s);
                audioChunks = [];
                mediaRecorder.start();
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                $('recordingUI').classList.remove('hidden');
                let sec = 0;
                timerInt = setInterval(() => {
                    sec++;
                    const m = Math.floor(sec/60).toString().padStart(2,'0');
                    $('recordingTime').textContent = `${m}:${(sec%60).toString().padStart(2,'0')}`;
                }, 1000);
            });
        };
        window.stopRecording = () => {
            if(mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks);
                    const reader = new FileReader();
                    reader.onload = e => sendMessage('audio', e.target.result);
                    reader.readAsDataURL(blob);
                    cancelRecording();
                };
            }
        };
        window.cancelRecording = () => {
            if(mediaRecorder) mediaRecorder.stop();
            clearInterval(timerInt);
            $('recordingUI').classList.add('hidden');
            $('recordingTime').textContent = '00:00';
        };
        window.playAudio = (src) => new Audio(src).play();

        $('fileInput').onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => sendMessage('image', ev.target.result);
                r.readAsDataURL(f);
            }
        };

        window.openCreateGroupModal = () => $('groupModal').classList.add('open');
        window.createGroup = async () => {
            const name = $('groupName').value;
            const checks = $('groupUserList').querySelectorAll('input:checked');
            if(!name || checks.length === 0) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
            
            const gid = push(ref(db, 'groups')).key;
            await update(ref(db, `user-chats/${currentUser.uid}/${gid}`), {
                name, timestamp: serverTimestamp(), unread: 0,
                lastMessage: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞'
            });
            
            $('groupModal').classList.remove('open');
            showToast('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)');
        };

        window.closeChat = () => $('mainArea').classList.remove('open');
        window.saveProfile = () => {
            const name = $('settingsName').value;
            const status = $('settingsStatus').value;
            update(ref(db, `users/${currentUser.uid}`), { name, status });
            showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        };
        function showToast(msg) {
            const t = $('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.filterList = (id, term) => {
            const list = $(id).children;
            for(let item of list) {
                item.style.display = item.innerText.toLowerCase().includes(term.toLowerCase()) ? 'flex' : 'none';
            }
        };

        window.toggleReaction = (chatUid, msgId, own) => {
            const chatId = activeChat.name ? chatUid : getChatId(chatUid);
            const rRef = ref(db, `messages/${chatId}/${msgId}/reaction`);
            get(rRef).then(s => {
                if(s.val()) remove(rRef);
                else set(rRef, true);
            });
        };
    </script>
</body>
</html>
